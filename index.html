<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RetireSaathi - Your Future Lifestyle Simulator</title>
    <!-- Tailwind CSS CDN for utility classes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter for body text, Poppins for headings for a modern feel -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Base body styling with a soft, warm gradient background */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to right bottom, #fcf6f0, #ffeccb); /* Soft, warm gradient */
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem; /* Consistent padding around the main card */
        }
        /* Poppins font for headings and special text elements */
        h1, h2, h3, .poppins {
            font-family: 'Poppins', sans-serif;
        }
        /* Main card styling - centered, rounded, with a subtle shadow and fade-in animation */
        .card {
            background-color: #ffffff;
            border-radius: 1.5rem; /* More rounded corners for a modern look */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); /* Softer shadow for elegance */
            padding: 2.5rem; /* Ample padding inside the card */
            animation: fadeIn 0.8s ease-out; /* Smooth fade-in effect on load */
            display: flex;
            flex-direction: column; /* Force single column layout by default */
            gap: 2.5rem; /* Space between major sections */
        }
        /* Keyframe animation for the fade-in effect */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Styling for the main content columns (input and output) */
        .input-column, .output-column {
            display: flex;
            flex-direction: column;
            /* Max-height and overflow for scrollability, especially on smaller screens */
            max-height: 70vh; /* Adjusted for better scroll visibility */
            overflow-y: auto; /* Enable vertical scrolling */
            padding-right: 1rem; /* Add padding to prevent scrollbar from overlaying content */
        }
        /* Custom scrollbar styling for a consistent look */
        .input-column::-webkit-scrollbar, .output-column::-webkit-scrollbar {
            width: 8px;
        }
        .input-column::-webkit-scrollbar-track, .output-column::-webkit-scrollbar-track {
            background: #fbd38d; /* Complementary orange for track */
            border-radius: 10px;
        }
        .input-column::-webkit-scrollbar-thumb, .output-column::-webkit-scrollbar-thumb {
            background: #dd6b20; /* Darker orange/red for thumb */
            border-radius: 10px;
        }
        .input-column::-webkit-scrollbar-thumb:hover, .output-column::-webkit-scrollbar-thumb:hover {
            background: #c05621; /* Slightly darker on hover */
        }

        /* Common styling for number and select inputs */
        input[type="number"], select {
            background-color: #f8fafc; /* bg-gray-50 */
            border-color: #cbd5e1; /* border-gray-300 */
            transition: all 0.2s ease-in-out; /* Smooth transitions for focus effects */
            border-width: 1px; /* Ensure border is visible */
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.5rem 0.75rem; /* py-2 px-3 */
            width: 100%; /* Full width */
        }
        input[type="number"]:focus, select:focus {
            ring-color: #f97316; /* orange-500 for focus ring */
            border-color: #f97316; /* orange-500 for border */
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.2); /* Custom ring shadow */
            outline: none; /* Remove default outline */
        }
        /* Button hover and active states for a more interactive feel */
        button {
            transition: all 0.2s ease-in-out;
            transform: scale(1);
        }
        button:hover {
            transform: scale(1.02); /* Slight scale-up on hover */
        }
        button:active {
            transform: scale(0.98); /* Slight scale-down on click */
        }

        /* Styling for range inputs (sliders) */
        input[type="range"] {
            -webkit-appearance: none; /* Remove default browser styling */
            width: 100%;
            height: 8px;
            background: #cbd5e1; /* gray-300 track */
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
            border-radius: 5px; /* Rounded track */
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        /* Slider thumb styling for Webkit browsers (Chrome, Safari) */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%; /* Circular thumb */
            background: #f97316; /* orange-500 thumb */
            cursor: pointer;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.2); /* Soft shadow around thumb */
        }
        /* Slider thumb styling for Mozilla Firefox */
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #f97316; /* orange-500 thumb */
            cursor: pointer;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.2);
        }

        /* Progress Bar Styling */
        .progress-bar-container {
            width: 100%;
            background-color: #e2e8f0; /* gray-200 background */
            border-radius: 9999px; /* Fully rounded */
            height: 18px; /* Slightly slimmer */
            overflow: hidden;
            margin-top: 1rem;
        }
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(to right, #4ade80, #16a34a); /* Green gradient for good health */
            width: 0%; /* Initial width */
            border-radius: 9999px;
            transition: width 0.7s cubic-bezier(0.25, 0.8, 0.25, 1.0); /* Smoother animation for width change */
        }
        .progress-bar-danger {
            background: linear-gradient(to right, #f87171, #ef4444); /* Red gradient for danger */
        }
        .progress-bar-warning {
            background: linear-gradient(to right, #fbbf24, #f59e0b); /* Amber gradient for warning */
        }

        /* Bar Chart Styling */
        .chart-container {
            display: flex;
            align-items: flex-end; /* Align bars to the bottom */
            justify-content: space-around;
            height: 180px; /* Taller chart for better visualization */
            border-bottom: 2px solid #e2e8f0; /* Lighter border at the bottom */
            padding-bottom: 1.5rem;
            gap: 0.5rem; /* More space between bars */
            position: relative; /* For absolute positioning of values/labels */
        }
        .chart-bar {
            flex-grow: 1; /* Allow bars to grow and fill space */
            background: linear-gradient(to top, #60a5fa, #3b82f6); /* Blue gradient for bars */
            transition: height 0.7s cubic-bezier(0.25, 0.8, 0.25, 1.0); /* Smooth height animation */
            border-radius: 0.5rem 0.5rem 0 0; /* Rounded top corners only */
            position: relative;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }
        .chart-bar-value {
            font-size: 0.75rem; /* text-xs */
            color: #ffffff; /* White text on bars */
            font-weight: 600;
            padding-bottom: 0.25rem;
            position: absolute;
            top: -1.5rem; /* Position above the bar */
            white-space: nowrap; /* Prevent value wrapping */
        }
        .chart-bar-label {
            font-size: 0.875rem; /* text-sm */
            color: #4a5568; /* gray-700 */
            text-align: center;
            position: absolute;
            bottom: -2.5rem; /* Position below the chart */
            width: 100%;
            font-weight: 500;
        }

        /* Scenario Item Styling */
        .scenario-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem; /* Space between emoji and text */
            background-color: #fbf7ed; /* Light orange tint */
            padding: 0.75rem;
            border-radius: 0.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); /* Subtle shadow */
        }
        .scenario-item span {
            font-size: 1.5rem; /* Larger emoji size */
        }
        .scenario-item p {
            font-size: 0.95rem;
            line-height: 1.5;
            color: #4a5568; /* gray-700 */
        }

        /* Investment Option Cards */
        .investment-card {
            border: 1px solid #e2e8f0; /* Light gray border */
            border-radius: 0.75rem;
            padding: 0.75rem;
            text-align: center;
            background-color: #fcfcfc; /* Slightly off-white background */
            box-shadow: 0 2px 6px rgba(0,0,0,0.05); /* Soft shadow */
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .investment-card:hover {
            transform: translateY(-2px); /* Slight lift on hover */
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); /* Enhanced shadow on hover */
        }
        .investment-card img {
            width: 60px; /* Smaller image for investment icons */
            height: 60px;
            object-fit: contain;
            margin: 0 auto 0.5rem; /* Centered with bottom margin */
        }
        .investment-card-title {
            font-weight: 600;
            font-size: 0.875rem; /* text-sm */
            color: #374151;
            margin-bottom: 0.25rem;
        }
        .investment-card-value {
            font-weight: 700;
            font-size: 1rem; /* text-base */
            color: #16a34a; /* green-600 for allocation percentage */
        }
        .investment-card-button {
            margin-top: 0.75rem;
            padding: 0.4rem 0.8rem;
            font-size: 0.75rem;
            border-radius: 0.5rem;
            background-color: #f97316; /* Orange background */
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .investment-card-button:hover {
            background-color: #ea580c; /* Darker orange on hover */
        }
        /* Styling for marketplace results display */
        .marketplace-result {
            background-color: #ecfdf5; /* green-50 */
            border: 1px solid #a7f3d0; /* green-200 */
            border-radius: 0.75rem;
            padding: 1rem;
            margin-top: 1.5rem;
            font-size: 0.9rem;
            color: #065f46; /* green-800 */
            line-height: 1.4;
        }

        /* Info modal styling */
        .info-modal {
            display: none; /* Hidden by default */
            position: absolute;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 0.5rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            z-index: 20;
            width: 250px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        .info-modal.active {
            display: block;
        }

        /* Responsive adjustments for smaller screens (mobile) */
        @media (max-width: 767px) {
            .card {
                padding: 1.5rem; /* Reduced padding on mobile */
            }
            .input-column, .output-column {
                max-height: 60vh; /* Adjust height for mobile scrolling */
                padding-right: 0.5rem; /* Reduced padding-right */
            }
            /* Adjust dropdown width for better fit on mobile */
            select {
                max-width: 100%;
            }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen items-center justify-center">
    <div class="container mx-auto p-6 md:p-10 lg:p-12 card w-full max-w-4xl">
        <!-- Input Section: User's Financial Blueprint and Dream Lifestyle Choices -->
        <div class="input-column space-y-6">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-6 poppins">Future You. Unlocked. ‚ú®</h1>
            <p class="text-gray-600 mb-8">Craft your dream retirement lifestyle and see the financial roadmap come alive!</p>

            <!-- Financial Blueprint Section -->
            <h3 class="text-2xl font-semibold text-orange-600 border-b-2 border-orange-200 pb-2 mb-4 poppins">Your Financial Blueprint</h3>

            <div class="grid grid-cols-1 gap-x-6 gap-y-4">
                <div class="space-y-4">
                    <!-- Current Age Slider -->
                    <div>
                        <label for="current-age" class="block text-gray-700 text-sm font-medium mb-1">Your Current Age:</label>
                        <input type="range" id="current-age" value="40" min="20" max="60" step="1" class="w-full">
                        <span id="current-age-value" class="text-gray-800 text-sm font-semibold">40 years</span>
                    </div>
                    <!-- Desired Retirement Age Slider -->
                    <div>
                        <label for="retirement-age" class="block text-gray-700 text-sm font-medium mb-1">Desired Retirement Age:</label>
                        <input type="range" id="retirement-age" value="60" min="60" max="75" step="1" class="w-full">
                        <span id="retirement-age-value" class="text-gray-800 text-sm font-semibold">60 years</span>
                    </div>
                    <!-- Life Expectancy Slider -->
                    <div>
                        <label for="life-expectancy" class="block text-gray-700 text-sm font-medium mb-1">Life Expectancy:</label>
                        <input type="range" id="life-expectancy" value="85" min="75" max="100" step="1" class="w-full">
                        <span id="life-expectancy-value" class="text-gray-800 text-sm font-semibold">85 years</span>
                    </div>
                </div>
                <div class="space-y-4">
                    <!-- Current Monthly Expenses Slider -->
                    <div>
                        <label for="monthly-expenses" class="block text-gray-700 text-sm font-medium mb-1">Current Monthly Expenses (‚Çπ):</label>
                        <input type="range" id="monthly-expenses" value="50000" min="10000" max="200000" step="5000" class="w-full">
                        <span id="monthly-expenses-value" class="text-gray-800 text-sm font-semibold">‚Çπ50,000</span>
                    </div>
                    <!-- Existing Retirement Savings Slider -->
                    <div>
                        <label for="existing-corpus" class="block text-gray-700 text-sm font-medium mb-1">Existing Retirement Savings (‚Çπ):</label>
                        <input type="range" id="existing-corpus" value="2000000" min="0" max="10000000" step="500000" class="w-full">
                        <span id="existing-corpus-value" class="text-gray-800 text-sm font-semibold">‚Çπ2,000,000</span>
                    </div>
                </div>
            </div>

            <!-- Dream Lifestyle Section -->
            <h3 class="text-2xl font-semibold text-orange-600 border-b-2 border-orange-200 pb-2 mb-4 mt-8 poppins">Your Dream Lifestyle üåü</h3>

            <!-- Desired Retirement City/Region Dropdown -->
            <div class="mb-4">
                <label for="city-select" class="block text-gray-700 text-sm font-medium mb-2">
                    Planned City or Area for Retirement:
                    <span id="city-info-icon" class="text-blue-500 cursor-pointer ml-1" title="Click for more info">‚ìò</span>
                </label>
                <select id="city-select" class="block w-full mt-1 border-gray-300 rounded-md shadow-sm focus:border-orange-500 focus:ring-orange-500">
                    <option value="bengaluru">Bengaluru</option>
                    <option value="mumbai">Mumbai</option>
                    <option value="delhi">Delhi</option>
                    <option value="chennai">Chennai</option>
                    <option value="hyderabad">Hyderabad</option>
                    <option value="kolkata">Kolkata</option>
                    <option value="pune">Pune</option>
                    <option value="ahmedabad">Ahmedabad</option>
                    <option value="surat">Surat</option>
                    <option value="jaipur">Jaipur</option>
                    <option value="lucknow">Lucknow</option>
                    <option value="kanpur">Kanpur</option>
                    <option value="nagpur">Nagpur</option>
                    <option value="visakhapatnam">Visakhapatnam</option>
                    <option value="indore">Indore</option>
                    <option value="bhopal">Bhopal</option>
                    <option value="patna">Patna</option>
                    <option value="ludhiana">Ludhiana</option>
                    <option value="agra">Agra</option>
                    <option value="nashik">Nashik</option>
                    <option value="faridabad">Faridabad</option>
                    <option value="meerut">Meerut</option>
                    <option value="rajkot">Rajkot</option>
                    <option value="varanasi">Varanasi</option>
                    <option value="srinagar">Srinagar</option>
                    <option value="aurangabad">Aurangabad</option>
                    <option value="dhanbad">Dhanbad</option>
                    <option value="amritsar">Amritsar</option>
                    <option value="allahabad">Allahabad</option>
                    <option value="ranchi">Ranchi</option>
                    <option value="goa">Goa (Beach)</option>
                    <option value="shimla">Shimla (Mountains)</option>
                    <option value="coimbatore">Coimbatore (Balanced)</option>
                    <option value="kochi">Kochi (Balanced)</option>
                </select>
                <!-- Info Modal for City Selection -->
                <div id="city-info-modal" class="info-modal hidden">
                    <p class="text-gray-800 text-sm">
                        RetireSaathi's AI considers historical inflation levels and cost of living adjustments for your selected city/region to provide a more accurate retirement expense projection.
                    </p>
                    <button class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-md text-sm" onclick="document.getElementById('city-info-modal').classList.add('hidden');">Got It!</button>
                </div>
            </div>

            <!-- Your Future Spend IQ Dropdown -->
            <div class="mb-4">
                <label for="spend-iq-select" class="block text-gray-700 text-sm font-medium mb-2">Your Future Spend IQ:</label>
                <select id="spend-iq-select" class="block w-full mt-1 border-gray-300 rounded-md shadow-sm focus:border-orange-500 focus:ring-orange-500">
                    <option value="maintain-as-today">Maintain as today</option>
                    <option value="simpler">Will be simpler (-15% expenses)</option>
                    <option value="higher">Higher than today (+20% expenses)</option>
                </select>
            </div>

            <!-- Passion Pursuits Dropdown -->
            <div class="mb-4">
                <label for="hobbies-select" class="block text-gray-700 text-sm font-medium mb-2">Passion Pursuits:</label>
                <select id="hobbies-select" class="block w-full mt-1 border-gray-300 rounded-md shadow-sm focus:border-orange-500 focus:ring-orange-500">
                    <option value="low">Relaxed (Chill & Unwind)</option>
                    <option value="medium">Active (Fitness & Clubs)</option>
                    <option value="high">Immersive (Create & Grow)</option>
                </select>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col md:flex-row gap-4 mt-6">
                <button id="simulate-lifestyle-btn" class="w-full md:w-auto flex-1 px-6 py-3 bg-gradient-to-r from-orange-500 to-red-500 text-white font-semibold rounded-full shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-orange-300 transform active:scale-98">
                    Simulate My Future! ‚ú®
                </button>
                <button id="clear-results-btn" class="w-full md:w-auto flex-1 px-6 py-3 bg-gray-200 text-gray-700 font-semibold rounded-full shadow-lg hover:bg-gray-300 focus:outline-none focus:ring-4 focus:ring-gray-300 transform active:scale-98">
                    Clear Results üîÑ
                </button>
            </div>
        </div>

        <!-- Output Section: Simulation Results and Insights -->
        <div id="simulation-output" class="output-column space-y-8 bg-orange-50 p-6 md:p-8 rounded-2xl shadow-inner border border-orange-200 hidden">
            <h3 class="text-3xl font-extrabold text-gray-800 border-b-2 border-green-400 pb-3 mb-6 poppins">Your Retirement Reality Check üöÄ</h3>

            <!-- Corpus Needed Display -->
            <div class="bg-white p-5 rounded-xl shadow-md flex justify-between items-center">
                <div>
                    <p class="text-lg font-medium text-gray-700 mb-1">Corpus Needed for Your Dream:</p>
                    <p id="corpus-needed" class="text-4xl font-bold text-green-700 poppins">‚Çπ0 Crore</p>
                </div>
                <span class="text-5xl">üí∞</span>
            </div>

            <!-- Projected Corpus Display -->
            <div class="bg-white p-5 rounded-xl shadow-md flex justify-between items-center">
                <div>
                    <p class="text-lg font-medium text-gray-700 mb-1">Your Projected Corpus at 60:</p>
                    <p id="projected-corpus" class="text-4xl font-bold text-blue-700 poppins">‚Çπ0 Crore</p>
                </div>
                <span class="text-5xl">üìà</span>
            </div>

            <!-- Funds Longevity and Health Bar -->
            <div class="bg-white p-5 rounded-xl shadow-md">
                <p class="text-lg font-medium text-gray-700 mb-2">Funds Projected to Last Until Age:</p>
                <p id="funds-last-until" class="text-3xl font-bold text-gray-800 poppins">--</p>
                <div class="progress-bar-container">
                    <div id="corpus-health-bar" class="progress-bar-fill"></div>
                </div>
                <p id="corpus-health-text" class="text-sm mt-2 font-medium text-gray-600 text-center">Corpus Health: Calculating...</p>
            </div>

            <!-- Monthly Expense Map (Bar Chart) -->
            <div class="bg-white p-5 rounded-xl shadow-md">
                <h4 class="text-xl font-semibold text-gray-800 mb-4 poppins">Monthly Expense Map üó∫Ô∏è</h4>
                <div class="chart-container" id="expense-chart">
                    <!-- Bars will be dynamically generated here -->
                </div>
                <div class="flex flex-wrap justify-around text-xs mt-4 text-gray-600" id="expense-labels-container">
                    <!-- Labels will be dynamically generated here to prevent overlap with bars -->
                </div>
            </div>

            <!-- A Glimpse into Your Retirement Day Scenario -->
            <div class="bg-white p-5 rounded-xl shadow-md">
                <h4 class="text-xl font-semibold text-gray-800 mb-4 poppins">A Glimpse into Your Day: üåÖ</h4>
                <div id="retirement-day-scenario" class="text-gray-700 space-y-3">
                    <!-- Scenario will be dynamically generated here -->
                </div>
            </div>

            <!-- AI Nudge and Investment Options Section -->
            <div id="ai-nudge-area" class="bg-blue-100 p-5 rounded-xl shadow-sm border border-blue-200 text-blue-800 hidden">
                <p class="font-semibold text-lg poppins mb-2">RetireSaathi Insight: ‚ú®</p>
                <p id="ai-nudge-text" class="text-sm leading-relaxed"></p>

                <h4 class="font-semibold text-lg poppins mt-6 mb-4">Bridge Your Gap with Smart Investments:</h4>
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-4" id="investment-options-container">
                    <!-- Investment cards will be dynamically generated here -->
                </div>
                <button id="auto-adjust-allocation-btn" class="mt-6 w-full px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition-colors duration-200">
                    Auto-Adjust My Allocation
                </button>
                <div id="marketplace-results-display" class="marketplace-result hidden">
                    <!-- Marketplace results will display here -->
                </div>
                <p class="text-xs text-blue-600 italic mt-3">Disclaimer: This simulation is for educational purposes only and not financial advice. Consult a certified financial advisor for personalized recommendations.</p>
            </div>
        </div>
    </div>

    <script>
        // --- Global Variables and Constants ---
        const INFLATION_RATE = 0.05; // 5% annual inflation rate
        const PRE_RETIREMENT_RETURN_RATE = 0.10; // 10% annual return on investments before retirement
        const POST_RETIREMENT_RETURN_RATE = 0.06; // 6% annual return during retirement
        const SAFETY_FACTOR = 1.15; // 15% buffer for unforeseen expenses or lifestyle creep

        // Cost multipliers for different city/region choices (simplified mapping)
        const CITY_COST_MULTIPLIERS = {
            'bengaluru': 1.0, 'mumbai': 1.1, 'delhi': 1.05, 'chennai': 0.95, 'hyderabad': 0.90,
            'kolkata': 0.85, 'pune': 0.75, 'ahmedabad': 0.70, 'surat': 0.65, 'jaipur': 0.60,
            'lucknow': 0.58, 'kanpur': 0.55, 'nagpur': 0.52, 'visakhapatnam': 0.70, 'indore': 0.68,
            'bhopal': 0.62, 'patna': 0.50, 'ludhiana': 0.57, 'agra': 0.53, 'nashik': 0.60,
            'faridabad': 0.80, 'meerut': 0.55, 'rajkot': 0.63, 'varanasi': 0.54, 'srinagar': 0.70,
            'aurangabad': 0.58, 'dhanbad': 0.48, 'amritsar': 0.61, 'allahabad': 0.56, 'ranchi': 0.51,
            'goa': 0.85,      // Specific for beach lifestyle
            'shimla': 0.70,   // Specific for mountain lifestyle
            'coimbatore': 0.72, // Specific for balanced/tier-2 city
            'kochi': 0.78       // Specific for balanced/tier-2 city
        };

        // Impact of future spend IQ level on overall expenses
        const FUTURE_SPEND_IQ_MULTIPLIERS = {
            'maintain-as-today': 1.0,
            'simpler': 0.85, // 15% reduction in lifestyle-related expenses
            'higher': 1.20   // 20% increase in lifestyle-related expenses
        };

        // Impact of hobbies level on expenses (as a percentage of base expenses)
        const HOBBIES_COST_IMPACTS = {
            'low': 0.03, 'medium': 0.08, 'high': 0.12
        };

        // Proportions of initial base monthly expenses for different categories
        const BASE_EXPENSE_PROPORTIONS = {
            'Housing': 0.30,
            'Food & Groceries': 0.25, /* Adjusted to account for removal of dining-out as separate input */
            'Utilities & Transport': 0.15, /* Adjusted for balance */
            'Healthcare Buffer': 0.15,
            'Miscellaneous': 0.15 /* Increased misc to capture other removed factors */
        };

        // --- Helper Functions ---

        /**
         * Calculates the future value of a present amount given an annual rate and years.
         * @param {number} presentValue - The initial amount.
         * @param {number} annualRate - The annual growth rate (e.g., 0.05 for 5%).
         * @param {number} years - The number of years.
         * @returns {number} The future value.
         */
        function calculateFutureValue(presentValue, annualRate, years) {
            return presentValue * Math.pow(1 + annualRate, years);
        }

        /**
         * Formats a given amount into Indian Rupee currency, converting to Crores or Lakhs
         * for large amounts for better readability.
         * @param {number} amount - The amount to format.
         * @returns {string} The formatted currency string (e.g., "‚Çπ1.50 Crore").
         */
        function formatCurrency(amount) {
            if (amount >= 10000000) { // If amount is 1 Crore or more
                return `‚Çπ${(amount / 10000000).toFixed(2)} Crore`;
            } else if (amount >= 100000) { // If amount is 1 Lakh or more
                return `‚Çπ${(amount / 100000).toFixed(2)} Lakhs`;
            } else { // Otherwise, just format as rupees
                return `‚Çπ${Math.round(amount).toLocaleString('en-IN')}`;
            }
        }

        /**
         * Formats a given amount into Indian Rupee currency (basic formatting for smaller values).
         * @param {number} amount - The amount to format.
         * @returns {string} The formatted rupee string (e.g., "‚Çπ50,000").
         */
        function formatRupees(amount) {
            return `‚Çπ${Math.round(amount).toLocaleString('en-IN')}`;
        }

        /**
         * Formats a given amount into Indian Rupee currency in thousands.
         * @param {number} amount - The amount to format.
         * @returns {string} The formatted rupee string in thousands (e.g., "‚Çπ50K").
         */
        function formatRupeesInThousands(amount) {
            if (amount >= 1000) {
                return `‚Çπ${(amount / 1000).toFixed(0)}K`; // Rounds to nearest K
            }
            return `‚Çπ${Math.round(amount)}`;
        }


        // --- DOM Elements ---
        // Buttons
        const simulateBtn = document.getElementById('simulate-lifestyle-btn');
        const clearResultsBtn = document.getElementById('clear-results-btn');

        // Output area container
        const simulationOutput = document.getElementById('simulation-output');

        // Input Sliders
        const currentAgeInput = document.getElementById('current-age');
        const retirementAgeInput = document.getElementById('retirement-age');
        const lifeExpectancyInput = document.getElementById('life-expectancy');
        const monthlyExpensesInput = document.getElementById('monthly-expenses');
        const existingCorpusInput = document.getElementById('existing-corpus');

        // Output Value Spans for Sliders (to display current slider value)
        const currentAgeValueSpan = document.getElementById('current-age-value');
        const retirementAgeValueSpan = document.getElementById('retirement-age-value');
        const lifeExpectancyValueSpan = document.getElementById('life-expectancy-value');
        const monthlyExpensesValueSpan = document.getElementById('monthly-expenses-value');
        const existingCorpusValueSpan = document.getElementById('existing-corpus-value');

        // New Dropdown Elements
        const citySelect = document.getElementById('city-select');
        const spendIqSelect = document.getElementById('spend-iq-select');
        const hobbiesSelect = document.getElementById('hobbies-select');

        // Info Icon and Modal for City Selection
        const cityInfoIcon = document.getElementById('city-info-icon');
        const cityInfoModal = document.getElementById('city-info-modal');


        // Output Display Elements
        const corpusNeededElem = document.getElementById('corpus-needed');
        const projectedCorpusElem = document.getElementById('projected-corpus');
        const fundsLastUntilElem = document.getElementById('funds-last-until');
        const corpusHealthBar = document.getElementById('corpus-health-bar');
        const corpusHealthText = document.getElementById('corpus-health-text');
        const expenseChart = document.getElementById('expense-chart');
        const expenseLabelsContainer = document.getElementById('expense-labels-container');
        const retirementDayScenario = document.getElementById('retirement-day-scenario');
        const aiNudgeArea = document.getElementById('ai-nudge-area');
        const aiNudgeText = document.getElementById('ai-nudge-text');

        // Investment Nudge Elements
        const investmentOptionsContainer = document.getElementById('investment-options-container');
        const autoAdjustAllocationBtn = document.getElementById('auto-adjust-allocation-btn');
        const marketplaceResultsDisplay = document.getElementById('marketplace-results-display');

        // --- Core Simulation Logic ---
        /**
         * Performs all retirement calculations and updates the UI with the results.
         */
        function updateSimulation() {
            // Update slider value displays immediately
            currentAgeValueSpan.textContent = `${currentAgeInput.value} years`;
            retirementAgeValueSpan.textContent = `${retirementAgeInput.value} years`;
            lifeExpectancyValueSpan.textContent = `${lifeExpectancyInput.value} years`;
            monthlyExpensesValueSpan.textContent = formatRupees(monthlyExpensesInput.value);
            existingCorpusValueSpan.textContent = formatRupees(existingCorpusInput.value);

            // Get input values from sliders
            const currentAge = parseInt(currentAgeInput.value);
            const retirementAge = parseInt(retirementAgeInput.value);
            const lifeExpectancy = parseInt(lifeExpectancyInput.value);
            const currentMonthlyExpenses = parseFloat(monthlyExpensesInput.value);
            const existingCorpus = parseFloat(existingCorpusInput.value);

            // Get selected lifestyle choices from dropdowns
            const cityChoice = citySelect.value;
            const futureSpendIQChoice = spendIqSelect.value;
            const hobbiesLevel = hobbiesSelect.value;

            // Basic Validation: Ensure sensible age and expense inputs for calculations
            if (currentAge <= 0 || retirementAge <= currentAge || lifeExpectancy <= retirementAge || currentMonthlyExpenses <= 0) {
                simulationOutput.classList.add('hidden'); // Hide output if inputs are invalid
                console.error("Invalid input values for simulation.");
                return; // Stop execution if inputs are invalid
            }

            // Show the output area now that inputs are valid
            simulationOutput.classList.remove('hidden');

            const yearsToRetirement = retirementAge - currentAge;
            const yearsInRetirement = lifeExpectancy - retirementAge;

            // 1. Calculate projected monthly expenses in retirement adjusted for inflation and city
            let futureMonthlyBaseExpenses = calculateFutureValue(currentMonthlyExpenses, INFLATION_RATE, yearsToRetirement);
            // Apply city cost multiplier based on selected city
            futureMonthlyBaseExpenses *= CITY_COST_MULTIPLIERS[cityChoice] || 1.0; // Default to 1.0 if city not found

            // Calculate hobbies cost based on a proportion of this *adjusted* base expense
            const hobbiesCostAmount = futureMonthlyBaseExpenses * HOBBIES_COST_IMPACTS[hobbiesLevel];

            // Sum up total projected monthly expenses for retirement
            // This includes the base proportions and the hobbies cost
            let projectedMonthlyExpensesRetired = (
                futureMonthlyBaseExpenses * (BASE_EXPENSE_PROPORTIONS.Housing + BASE_EXPENSE_PROPORTIONS['Food & Groceries'] + BASE_EXPENSE_PROPORTIONS['Utilities & Transport'] + BASE_EXPENSE_PROPORTIONS['Healthcare Buffer'] + BASE_EXPENSE_PROPORTIONS.Miscellaneous) +
                hobbiesCostAmount
            );

            // Apply Future Spend IQ multiplier to the total projected expenses
            projectedMonthlyExpensesRetired *= FUTURE_SPEND_IQ_MULTIPLIERS[futureSpendIQChoice];

            // Finally, apply the overall safety factor
            projectedMonthlyExpensesRetired *= SAFETY_FACTOR;

            const projectedAnnualExpensesRetired = projectedMonthlyExpensesRetired * 12;

            // 2. Calculate Required Corpus (Corpus Needed) using a safe withdrawal rate (e.g., 4% rule)
            const safeWithdrawalRate = 0.04; // A common safe withdrawal rate
            const corpusNeeded = projectedAnnualExpensesRetired / safeWithdrawalRate;

            // 3. Calculate Projected Corpus at Retirement (based on existing savings growth)
            const projectedCorpus = calculateFutureValue(existingCorpus, PRE_RETIREMENT_RETURN_RATE, yearsToRetirement);

            // 4. Calculate Funds Last Until Age (longevity of corpus)
            let remainingCorpus = projectedCorpus;
            let actualYearsLasting = retirementAge;
            let fundsRunOut = false;

            // Simulate year-by-year depletion of corpus, accounting for post-retirement returns and inflation
            for (let year = 0; year <= yearsInRetirement + 15; year++) { // Check well beyond expected life expectancy
                let expensesThisYear = projectedAnnualExpensesRetired * Math.pow(1 + INFLATION_RATE, year); // Expenses inflate annually
                remainingCorpus = remainingCorpus * (1 + POST_RETIREMENT_RETURN_RATE) - expensesThisYear; // Corpus grows, then expenses are deducted
                if (remainingCorpus <= 0) {
                    actualYearsLasting = retirementAge + year; // Funds run out this year
                    fundsRunOut = true;
                    break;
                } else {
                    actualYearsLasting = retirementAge + year + 1; // Funds last at least until next year
                }
            }

            // Update UI with longevity result
            if (!fundsRunOut && actualYearsLasting >= lifeExpectancy) {
                fundsLastUntilElem.innerHTML = `${lifeExpectancy} (and beyond! ü•≥)`; // Funds last beyond life expectancy
            } else if (fundsRunOut) {
                fundsLastUntilElem.innerHTML = `${actualYearsLasting} üòî`; // Funds run out before or at life expectancy
            } else {
                fundsLastUntilElem.innerHTML = `Error calculating longevity.`; // Fallback for unexpected cases
            }

            // Update main corpus display elements
            corpusNeededElem.textContent = formatCurrency(corpusNeeded);
            projectedCorpusElem.textContent = formatCurrency(projectedCorpus);

            // Update Corpus Health Bar and Text
            let healthPercentage = Math.min(100, (projectedCorpus / corpusNeeded) * 100); // Max 100%
            corpusHealthBar.style.width = `${healthPercentage}%`;
            corpusHealthBar.classList.remove('progress-bar-danger', 'progress-bar-warning'); // Reset visual states

            let healthStatusText = "On Track! Awesome! üí™";
            if (healthPercentage < 50) {
                corpusHealthBar.classList.add('progress-bar-danger'); // Red for significant gap
                healthStatusText = "Significant Gap! Time to boost savings! üö®";
            } else if (healthPercentage < 80) {
                corpusHealthBar.classList.add('progress-bar-warning'); // Amber for moderate gap
                healthStatusText = "Needs Attention! Almost there! üí°";
            }
            corpusHealthText.textContent = `Corpus Health: ${healthStatusText} (${Math.round(healthPercentage)}% of target)`;

            // Update Monthly Expense Breakdown (Bar Chart)
            renderExpenseChart(projectedMonthlyExpensesRetired, hobbiesCostAmount, futureMonthlyBaseExpenses);

            // Update Simulated Retirement Day Scenario
            renderRetirementDayScenario(cityChoice, futureSpendIQChoice, hobbiesLevel, projectedMonthlyExpensesRetired);

            // Update AI Nudge & Investment Options
            renderAiNudge(corpusNeeded, projectedCorpus, yearsToRetirement, cityChoice, futureSpendIQChoice, hobbiesLevel);
        }

        // --- Chart Rendering ---
        /**
         * Renders the bar chart for monthly expense breakdown.
         * @param {number} totalMonthlyExpenses - Total estimated monthly expenses in retirement.
         * @param {number} hobbiesCost - Estimated monthly hobbies cost.
         * @param {number} baseMonthlyExpenses - The base monthly expenses (before lifestyle additions).
         */
        function renderExpenseChart(totalMonthlyExpenses, hobbiesCost, baseMonthlyExpenses) {
            // Define dynamic expense categories and their calculated amounts
            const dynamicExpenses = {
                'Housing üè†': baseMonthlyExpenses * BASE_EXPENSE_PROPORTIONS.Housing,
                'Food & Groceries üçé': baseMonthlyExpenses * BASE_EXPENSE_PROPORTIONS['Food & Groceries'],
                'Utilities & Transport üí°': baseMonthlyExpenses * BASE_EXPENSE_PROPORTIONS['Utilities & Transport'],
                'Healthcare Buffer ‚ù§Ô∏è': baseMonthlyExpenses * BASE_EXPENSE_PROPORTIONS['Healthcare Buffer'],
                'Hobbies üé®': hobbiesCost,
                'Miscellaneous üõí': baseMonthlyExpenses * BASE_EXPENSE_PROPORTIONS.Miscellaneous
            };

            expenseChart.innerHTML = ''; // Clear previous bars
            expenseLabelsContainer.innerHTML = ''; // Clear previous labels

            let maxExpenseValue = 0;
            // Find the maximum expense value to normalize bar heights
            for (const category in dynamicExpenses) {
                if (dynamicExpenses[category] > maxExpenseValue) {
                    maxExpenseValue = dynamicExpenses[category];
                }
            }
            if (maxExpenseValue === 0) maxExpenseValue = 1; // Prevent division by zero if all expenses are zero

            // Define the order of categories for the chart display
            const categoriesOrdered = [
                'Housing üè†', 'Food & Groceries üçé', 'Utilities & Transport üí°',
                'Healthcare Buffer ‚ù§Ô∏è', 'Hobbies üé®', 'Miscellaneous üõí'
            ];

            // Create and append bars and labels
            for (const category of categoriesOrdered) {
                const value = dynamicExpenses[category];
                // Calculate bar height as a percentage of the maximum value (max 90% to leave room for labels)
                const heightPercentage = (value / maxExpenseValue) * 90;

                const bar = document.createElement('div');
                bar.className = 'chart-bar flex items-center justify-center';
                // Set bar height, ensuring a minimum height for visibility even if value is small
                bar.style.height = `${Math.max(5, heightPercentage)}%`;

                const valueSpan = document.createElement('span');
                valueSpan.className = 'chart-bar-value';
                // Display amount in thousands on top of each bar
                valueSpan.textContent = formatRupeesInThousands(value);
                bar.appendChild(valueSpan);

                expenseChart.appendChild(bar);

                // Add labels separately below the chart for better layout control
                const labelDiv = document.createElement('div');
                labelDiv.className = 'text-center text-gray-700 text-xs font-medium flex-shrink-0';
                // Calculate label width to distribute evenly
                labelDiv.style.width = `calc(100% / ${categoriesOrdered.length} - 0.5rem)`;
                labelDiv.textContent = category.split(' ')[0]; // Show only the first word of the category name
                expenseLabelsContainer.appendChild(labelDiv);
            }
            // Ensure the label container spans full width and distributes labels correctly
            expenseLabelsContainer.style.width = '100%';
            expenseLabelsContainer.style.justifyContent = 'space-around';
        }

        // --- Scenario Generation ---
        /**
         * Generates a dynamic narrative scenario for a typical retirement day based on user choices.
         * @param {string} city - The selected city/region.
         * @param {string} futureSpendIQ - The selected future spend IQ level.
         * @param {string} hobbies - The selected hobbies level.
         * @param {number} monthlyExpenses - The calculated projected monthly expenses.
         */
        function renderRetirementDayScenario(city, futureSpendIQ, hobbies, monthlyExpenses) {
            // Format city name for display (capitalize and handle specific names)
            let cityDisplayName = city.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
            if (city === 'goa') cityDisplayName = 'Goa (Beach)';
            if (city === 'shimla') cityDisplayName = 'Shimla (Mountains)';

            let scenarioElements = [];

            scenarioElements.push({ emoji: 'üßò‚Äç‚ôÄÔ∏è', text: `Imagine a vibrant day in your retired life in <strong>${cityDisplayName}</strong>...` });

            let morningActivity = "";
            if (hobbies === 'high') {
                morningActivity = "Your mornings are dedicated to deep dives into your passions, perhaps a painting session or coding new projects. Pure bliss!";
            } else if (hobbies === 'medium') {
                morningActivity = "You kickstart your day with a refreshing yoga session, a brisk walk, or a friendly game at your local club.";
            } else { // low hobbies
                morningActivity = "Your mornings are leisurely, perhaps enjoying a hot cup of chai and a good book.";
            }
            scenarioElements.push({ emoji: '‚òÄÔ∏è', text: morningActivity });

            let afternoonActivity = "";
            let spendIQDescription = "";
            if (futureSpendIQ === 'higher') {
                spendIQDescription = "Your afternoons might involve frequent outings to explore new places, indulge in fine dining, or engage in exclusive cultural events.";
            } else if (futureSpendIQ === 'simpler') {
                spendIQDescription = "Afternoons are often serene, with simple pleasures like a walk in a local park, or a quiet meal at home.";
            } else { // maintain-as-today
                spendIQDescription = "Your afternoons are balanced, perhaps a relaxed lunch with friends or a visit to a local market.";
            }
            scenarioElements.push({ emoji: 'üçΩÔ∏è', text: afternoonActivity + spendIQDescription });


            let eveningActivity = "";
            if (hobbies === 'high' && futureSpendIQ === 'higher') {
                eveningActivity = "Evenings might bring you to a live concert, a theatre play, or a vibrant social gathering, followed by an exquisite dinner.";
            } else if (hobbies === 'high') {
                eveningActivity = "You wrap up your day immersing yourself in your favorite immersive hobby.";
            } else if (futureSpendIQ === 'simpler') {
                eveningActivity = "Your evenings are calm and cozy, cherishing quiet moments and family time.";
            } else { // maintain as today or medium hobbies
                eveningActivity = "Evenings often involve relaxed dinners at home, perhaps with a quiet movie or catching up with loved ones.";
            }
            scenarioElements.push({ emoji: 'üåô', text: eveningActivity });

            scenarioElements.push({ emoji: 'üíµ', text: `This amazing lifestyle translates to an estimated monthly spend of <strong>${formatRupees(monthlyExpenses)}</strong>.` });

            retirementDayScenario.innerHTML = ''; // Clear previous scenario
            // Append each scenario item to the display area
            scenarioElements.forEach(item => {
                const div = document.createElement('div');
                div.className = 'scenario-item';
                div.innerHTML = `<span class="text-2xl">${item.emoji}</span><p>${item.text}</p>`;
                retirementDayScenario.appendChild(div);
            });
        }

        // --- AI Nudge Logic ---
        // Predefined investment options with mock data
        const investmentOptions = [
            { id: 'fractional', title: 'Fractional Investments', img: 'https://placehold.co/60x60/f87171/FFF?text=FI', description: 'High Growth Potential, Diverse Assets', currentAllocation: 0 },
            { id: 'mutual-funds', title: 'Mutual Funds', img: 'https://placehold.co/60x60/34d399/FFF?text=MF', description: 'Professionally Managed, Diversified', currentAllocation: 0 },
            { id: 'gold', title: 'Gold', img: 'https://placehold.co/60x60/fbbf24/000?text=Gold', description: 'Inflation Hedge, Safe Haven', currentAllocation: 0 },
            { id: 'crypto', title: 'Crypto', img: 'https://placehold.co/60x60/818cf8/FFF?text=Crypto', description: 'Emerging Digital Assets, Volatile', currentAllocation: 0 },
            { id: 'nft', title: 'NFTs', img: 'https://placehold.co/60x60/c084fc/FFF?text=NFT', description: 'Digital Collectibles, Unique Value', currentAllocation: 0 }
        ];

        /**
         * Renders the investment option cards with their respective allocations.
         * @param {object} allocations - An object mapping investment IDs to their percentage allocations.
         */
        function renderInvestmentCards(allocations) {
            investmentOptionsContainer.innerHTML = ''; // Clear previous cards
            investmentOptions.forEach(option => {
                const card = document.createElement('div');
                card.className = 'investment-card';
                card.innerHTML = `
                    <img src="${option.img}" alt="${option.title}">
                    <div class="investment-card-title">${option.title}</div>
                    <div class="investment-card-value" data-id="${option.id}-allocation">${allocations[option.id]}%</div>
                    <button class="investment-card-button" data-category="${option.id}">Find Options</button>
                `;
                investmentOptionsContainer.appendChild(card);
            });

            // Add event listeners to the new "Find Options" buttons
            investmentOptionsContainer.querySelectorAll('.investment-card-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const category = event.target.dataset.category;
                    showMarketplaceOptions(category); // Display mock marketplace options for the selected category
                });
            });
        }

        /**
         * Calculates and displays a simplified auto-adjusted investment allocation
         * based on years to retirement (risk profiling).
         */
        function autoAdjustAllocation() {
            const yearsToRetirement = parseInt(retirementAgeInput.value) - parseInt(currentAgeInput.value);
            let allocations = {};
            
            // Simplified risk profiling:
            if (yearsToRetirement >= 20) { // Younger, more aggressive portfolio
                allocations = {
                    'fractional': 20, 'mutual-funds': 40, 'gold': 10, 'crypto': 20, 'nft': 10
                };
            } else if (yearsToRetirement >= 10) { // Mid-career, balanced portfolio
                allocations = {
                    'fractional': 15, 'mutual-funds': 55, 'gold': 15, 'crypto': 10, 'nft': 5
                };
            } else { // Closer to retirement, more conservative portfolio
                allocations = {
                    'fractional': 5, 'mutual-funds': 65, 'gold': 20, 'crypto': 5, 'nft': 5
                };
            }
            
            // Re-render investment cards with the newly calculated allocations
            renderInvestmentCards(allocations);
            marketplaceResultsDisplay.classList.add('hidden'); // Hide marketplace results when re-adjusting
        }

        /**
         * Displays mock marketplace options for a given investment category.
         * @param {string} category - The investment category (e.g., 'mutual-funds').
         */
        function showMarketplaceOptions(category) {
            marketplaceResultsDisplay.classList.remove('hidden'); // Show the marketplace display area
            let resultText = `Searching for top <strong>${category.replace('-', ' ').split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')}</strong> investment options...<br><br>`;
            
            // Mock data for different investment categories
            const marketplaceData = {
                'fractional': [
                    "AssetY - Commercial Real Estate (Delhi)",
                    "ArtFolio - Rare Indian Art Collection",
                    "GrowVest - Pre-IPO Startup Shares"
                ],
                'mutual-funds': [
                    "Axis Bluechip Fund - Direct Growth",
                    "Parag Parikh Flexi Cap Fund - Direct Growth",
                    "ICICI Prudential Nifty Next 50 Index Fund"
                ],
                'gold': [
                    "MMTC-PAMP Digital Gold",
                    "HDFC Gold ETF",
                    "Sovereign Gold Bond (RBI)"
                ],
                'crypto': [
                    "Bitcoin (BTC) - via CoinDCX",
                    "Ethereum (ETH) - via WazirX",
                    "Polygon (MATIC) - via ZebPay"
                ],
                'nft': [
                    "Indian Digital Art Collection (Platform A)",
                    "Sports Memorabilia NFTs (Platform B)",
                    "Emerging Creator Series (Platform C)"
                ]
            };

            resultText += `Here are some popular options for <strong>${category.replace('-', ' ').split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')}</strong>:<br><ul>`;
            // Add each item from the mock data to the list
            if (marketplaceData[category]) {
                marketplaceData[category].forEach(item => {
                    resultText += `<li>‚Ä¢ ${item}</li>`;
                });
            } else {
                resultText += `<li>No specific options found for this category yet.</li>`;
            }
            
            resultText += `</ul><br>Connecting you to the right platforms for these! üöÄ`;

            marketplaceResultsDisplay.innerHTML = resultText; // Update the display with results
        }


        /**
         * Renders AI-driven financial insights and nudges based on the simulation results.
         * @param {number} corpusNeeded - The calculated corpus required for the dream lifestyle.
         * @param {number} projectedCorpus - The user's projected corpus at retirement.
         * @param {number} yearsToRetirement - Years remaining until retirement.
         * @param {string} cityChoice - Selected city/region.
         * @param {string} futureSpendIQChoice - Selected spend IQ level.
         * @param {string} hobbiesLevel - Selected hobbies level.
         */
        function renderAiNudge(corpusNeeded, projectedCorpus, yearsToRetirement, cityChoice, futureSpendIQChoice, hobbiesLevel) {
            aiNudgeArea.classList.remove('hidden'); // Show the AI nudge area
            let nudgeText = "";

            if (projectedCorpus >= corpusNeeded) {
                // Positive feedback if goals are met or exceeded
                nudgeText = "You are smashing your retirement goals! Your plan is on track to fund your desired lifestyle with confidence. Keep up the brilliant work! üéâ";
            } else {
                // Calculate the deficit and potential monthly SIP needed to cover it
                const deficit = corpusNeeded - projectedCorpus;
                let monthlySIPNeeded = 0;
                if (yearsToRetirement > 0) {
                    // Formula for SIP needed to reach a target future value
                    monthlySIPNeeded = (deficit * (PRE_RETIREMENT_RETURN_RATE / 12)) / (Math.pow(1 + (PRE_RETIREMENT_RETURN_RATE / 12), yearsToRetirement * 12) - 1);
                } else {
                    monthlySIPNeeded = deficit; // If already at retirement, the deficit is the lump sum needed
                }

                nudgeText = `Your current path shows a gap of <strong>${formatCurrency(deficit)}</strong>. To truly live your dream, RetireSaathi suggests you consider:`;

                let specificSuggestions = [];

                // Suggestions based on the financial gap and time to retirement
                if (monthlySIPNeeded > 50000 && yearsToRetirement < 10) { // Large gap, short time
                    specificSuggestions.push(`Boosting your monthly savings by around <strong>${formatRupees(monthlySIPNeeded)}</strong>. It's a significant leap, but your dream retirement is worth it!`);
                    specificSuggestions.push(`Exploring extending your working years by 2-5 years to build more corpus. Every extra year can make a remarkable difference!`);
                } else if (monthlySIPNeeded > 10000 && yearsToRetirement >= 10) { // Moderate gap, decent time
                    specificSuggestions.push(`Increasing your monthly savings by approximately <strong>${formatRupees(monthlySIPNeeded)}</strong>. Small, consistent increases today can lead to big rewards tomorrow!`);
                } else if (monthlySIPNeeded > 0) { // Small gap
                    specificSuggestions.push(`Adding just <strong>${formatRupees(monthlySIPNeeded)}</strong> to your monthly savings to comfortably bridge the gap. You're so close to unlocking your dream!`);
                }

                // Lifestyle-specific nudges to reduce expenses if there's a deficit
                if (futureSpendIQChoice === 'higher' && deficit > 0) {
                    specificSuggestions.push(`While a 'Higher' spend IQ is fun, a slightly 'Simpler' approach could significantly extend your corpus. Find joy in smarter spending! üí∞‚û°Ô∏èüßò`);
                }
                if (hobbiesLevel === 'high' && deficit > 0) {
                    specificSuggestions.push(`Exploring more budget-friendly passion pursuits or finding creative ways to monetize your immersive hobbies could give your corpus a boost! üé®üí∞`);
                }
                if (CITY_COST_MULTIPLIERS[cityChoice] > 0.8 && deficit > 0) { // If a higher cost city is selected
                    specificSuggestions.push(`Considering a move to a beautiful Tier-2 city or a peaceful small town upon retirement could significantly reduce living costs and stretch your corpus further! üèôÔ∏è‚û°Ô∏èüèûÔ∏è`);
                }

                // Generic suggestion if no specific lifestyle nudge applies but there's still a gap
                if (specificSuggestions.length === 0 && deficit > 0) {
                    specificSuggestions.push(`Boosting your monthly savings consistently. Every little bit truly helps!`);
                }

                // Update the AI nudge text with suggestions
                aiNudgeText.innerHTML = nudgeText + (specificSuggestions.length > 0 ? `<ul>` + specificSuggestions.map(s => `<li>‚Ä¢ ${s}</li>`).join('') + `</ul>` : '');
            }
            // Always render investment cards with a default or last-known allocation
            const initialAllocations = {
                'fractional': 10, 'mutual-funds': 60, 'gold': 15, 'crypto': 10, 'nft': 5 // A balanced default allocation
            };
            renderInvestmentCards(initialAllocations);
        }

        // --- Event Listeners and Initialization ---

        // Event listener for the main "Simulate My Future!" button
        simulateBtn.addEventListener('click', updateSimulation);

        // Event listener for the "Clear Results" button
        clearResultsBtn.addEventListener('click', () => {
            simulationOutput.classList.add('hidden'); // Hide the entire output column
            marketplaceResultsDisplay.classList.add('hidden'); // Ensure marketplace results are also hidden
            // You could also add logic here to reset input values to defaults if desired
        });

        // Add event listeners for slider inputs to ONLY update their display values in real-time.
        // Full simulation is triggered only by the main "Simulate" button.
        const sliderInputs = [
            currentAgeInput, retirementAgeInput, lifeExpectancyInput,
            monthlyExpensesInput, existingCorpusInput
        ];

        sliderInputs.forEach(input => {
            input.addEventListener('input', () => {
                // Update only the associated span value text based on the slider's ID
                switch(input.id) {
                    case 'current-age': currentAgeValueSpan.textContent = `${input.value} years`; break;
                    case 'retirement-age': retirementAgeValueSpan.textContent = `${input.value} years`; break;
                    case 'life-expectancy': lifeExpectancyValueSpan.textContent = `${input.value} years`; break;
                    case 'monthly-expenses': monthlyExpensesValueSpan.textContent = formatRupees(input.value); break;
                    case 'existing-corpus': existingCorpusValueSpan.textContent = formatRupees(input.value); break;
                }
            });
        });

        // Event listener for the City Info Icon
        cityInfoIcon.addEventListener('click', () => {
            cityInfoModal.classList.toggle('hidden'); // Toggle visibility of the modal
        });

        // Event listener for the "Auto-Adjust Allocation" button
        autoAdjustAllocationBtn.addEventListener('click', autoAdjustAllocation);

        // --- Initial Page Load Setup ---
        // On page load, only initialize slider displays and dropdown selections.
        // The full simulation output is hidden until the user clicks "Simulate My Future!".
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize slider value displays with their default HTML values
            currentAgeValueSpan.textContent = `${currentAgeInput.value} years`;
            retirementAgeValueSpan.textContent = `${retirementAgeInput.value} years`;
            lifeExpectancyValueSpan.textContent = `${lifeExpectancyInput.value} years`;
            monthlyExpensesValueSpan.textContent = formatRupees(monthlyExpensesInput.value);
            existingCorpusValueSpan.textContent = formatRupees(existingCorpusInput.value);

            // Set default selected values for dropdowns (based on their HTML default)
            citySelect.value = 'bengaluru';
            spendIqSelect.value = 'maintain-as-today';
            hobbiesSelect.value = 'medium';

            // Ensure the output section is hidden initially
            simulationOutput.classList.add('hidden');
        });
    </script>
</body>
</html>
